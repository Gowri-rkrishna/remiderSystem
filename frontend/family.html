<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Medicare Connect â€“ Family Dashboard</title>
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; img-src 'self' data:">
<link rel="stylesheet" href="style.css">
</head>
<body>

<!-- Animated background -->
<div class="blob-extra"></div>
<div class="stars-layer" id="stars"></div>

<div class="container dashboard">

  <div class="dash-header">
    <div style="display:flex;align-items:center;gap:12px;">
      <div class="brand-icon">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§</div>
      <span class="dash-title">Family Dashboard</span>
    </div>
    <span class="user-badge" id="userBadge">ğŸ‘¤ Family</span>
  </div>

  <!-- Link Patient -->
  <div class="card">
    <h3>ğŸ”— Link Patient</h3>
    <input type="text" id="patientLinkId" placeholder="Enter Patient ID (e.g. PAT1234)">
    <button onclick="linkPatient()">Link Patient</button>
  </div>

  <!-- Add Medicine -->
  <div class="card">
    <h3>â• Add Medicine</h3>
    <input type="text"  id="medName" placeholder="Medicine Name">
    <input type="time"  id="time">
    <input type="text"  id="dose"    placeholder="Dose (e.g. 1 Tablet)">
    <button onclick="addMedicine()">Add Medicine</button>
  </div>

  <!-- Monitoring -->
  <div style="display: flex; justify-content: space-between; align-items: center; margin: 22px 0 10px;">
    <h3 style="margin: 0;">ğŸ“Š Monitoring</h3>
    <button onclick="refreshMonitor()" style="padding: 8px 14px; font-size: 12px; background: #7c3aed; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">ğŸ”„ Refresh</button>
  </div>
  <div id="monitorList">
    <div class="empty-state">
      <div class="empty-icon">ğŸ“‹</div>
      <p>Link a patient and add medicines<br>to start monitoring.</p>
    </div>
  </div>

  <button class="logout-btn" onclick="logout()">ğŸšª Logout</button>
</div>

<script src="script.js"></script>
<script>
  /* Stars */
  (function(){
    var s=document.getElementById('stars');
    for(var i=0;i<75;i++){
      var d=document.createElement('div');d.className='star';
      var sz=Math.random()*2.5+0.8;
      d.style.cssText='width:'+sz+'px;height:'+sz+'px;top:'+Math.random()*100+'%;left:'+Math.random()*100+'%;animation-delay:'+Math.random()*5+'s;animation-duration:'+(2+Math.random()*4)+'s;';
      s.appendChild(d);
    }
  })();

  /* Badge */
  var cu = JSON.parse(localStorage.getItem("currentUser") || "{}");
  if (cu.name) document.getElementById("userBadge").innerText = "ğŸ‘¤ " + cu.name;

  /* Refresh monitor panel */
  function isTimeOverdue(medicineTime) {
    var now = new Date();
    var currentHours = String(now.getHours()).padStart(2, '0');
    var currentMinutes = String(now.getMinutes()).padStart(2, '0');
    var currentTime = currentHours + ':' + currentMinutes;
    return currentTime > medicineTime;
  }

  // Notification: show only once
  var NOTIFICATION_SHOWN = false;

  function refreshMonitor() {
    cu = JSON.parse(localStorage.getItem("currentUser") || "{}");
    if (!cu.linkedPatientId) return;
    var meds = JSON.parse(localStorage.getItem("meds") || "[]");
    var container = document.getElementById("monitorList");
    var filtered = meds.filter(function(m){ return m.patientId === cu.linkedPatientId; });
    if (filtered.length === 0) {
      container.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ’Š</div><p>No medicines added yet for this patient.</p></div>';
      return;
    }
    
    var hasOverdue = false;
    container.innerHTML = filtered.map(function(med){
      var isOverdue = !med.taken && isTimeOverdue(med.time);
      if (isOverdue) hasOverdue = true;
      
      var statusClass = med.taken ? 'taken' : (isOverdue ? 'overdue' : 'pending');
      var statusText = med.taken ? 'âœ… Taken' : (isOverdue ? 'ğŸš¨ OVERDUE - NOT TAKEN' : 'â³ Pending');
      var cardClass = isOverdue ? 'medicine-card overdue-card' : 'medicine-card';
      
      return '<div class="' + cardClass + '">' +
        '<h3>ğŸ’Š ' + med.name + '</h3>' +
        '<p>â° Time: ' + med.time + '</p>' +
        '<p>ğŸ’‰ Dose: ' + med.dose + '</p>' +
        '<span class="status ' + statusClass + '">' +
        statusText + '</span>' +
        '</div>';
    }).join('');
    
    // Show browser notification for overdue medicines (only once)
    if (hasOverdue && !NOTIFICATION_SHOWN) {
      if (Notification && Notification.permission === "granted") {
        new Notification("âš ï¸ Medicare Alert", {
          body: "One or more medicines are overdue!",
          icon: "ğŸ’Š"
        });
        NOTIFICATION_SHOWN = true;
      }
    }
    
    // Reset notification flag if no overdue medicines
    if (!hasOverdue) {
      NOTIFICATION_SHOWN = false;
    }
  }

  // Request notification permission
  if (Notification && Notification.permission === "default") {
    Notification.requestPermission();
  }

  refreshMonitor();

  // Auto-refresh monitoring every 3 seconds
  setInterval(refreshMonitor, 3000);

  function logout() {
    localStorage.removeItem("currentUser");
    localStorage.removeItem("autoLogin");
    window.location.href = "login.html";
  }
</script>
</body>
</html>